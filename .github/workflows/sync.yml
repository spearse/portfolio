name: Sync Approved Summaries

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"   # Every Monday 09:00 UTC (optional)

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Checkout private repo (read-only)
        uses: actions/checkout@v4
        with:
          repository: spearse/projectsummaries   # <-- your PRIVATE repo name
          token: ${{ secrets.PRIVATE_REPO_PAT }} # <-- fine-grained PAT secret on public repo
          path: private_src
          ref: main
          submodules: false
          fetch-depth: 1

      - name: Prepare folders
        run: |
          mkdir -p projects
          # DISABLED: rm -rf projects/*
          # Project files are now manually maintained with full Jekyll front matter
          echo "Project files are manually maintained"

      - name: Set up Python for transformation
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Copy and transform project summaries from portfolio-web
        run: |
          # File mappings: source (in projectSummaries/portfolio-web) -> destination (in portfolio/projects)
          declare -A mappings=(
            ["density-copilot.md"]="01-Density-Copilot.md"
            ["density-daw.md"]="02-Density-DAW.md"
            ["density-fullstack.md"]="05-Density-Web-Platform.md"
          )

          # NOTE: Files 03-Compose-with-Sounds.md and 04-CLaMP3-Audio-Semantic-Search.md
          # are not yet in projectSummaries/portfolio-web, so they remain manually maintained

          for source in "${!mappings[@]}"; do
            dest="${mappings[$source]}"
            source_path="private_src/portfolio-web/$source"
            dest_path="projects/$dest"

            if [ -f "$source_path" ]; then
              echo "Processing $source -> $dest"

              # Extract title and number
              title=$(head -n 1 "$source_path" | sed 's/^# //' | sed 's/ - .*//')
              number=$(echo "$dest" | grep -oE '^[0-9]+')

              # Create file with front matter
              cat > "$dest_path" <<FRONTMATTER
          ---
          layout: default
          title: $title
          permalink: /projects/${dest%.md}.html
          ---

          FRONTMATTER

              # Append content
              cat "$source_path" >> "$dest_path"

              echo "✅ Copied $dest"
            else
              echo "⚠️  Source file not found: $source_path"
            fi
          done

          echo ""
          echo "⚠️  NOTE: Visual formatting needs to be applied manually or via Claude Code"
          echo "Reference template: projects/02-Density-DAW.md"
          
      - name: Ensure front-matter on project pages
        run: |
          for f in projects/*.md; do
            # If file already has front matter, skip
            if [ "$(head -n1 "$f")" = "---" ]; then
              continue
            fi
            title="$(basename "$f" .md | sed 's/^[0-9]\+-//' | sed 's/-/ /g')"
            tmp="$(mktemp)"
            {
              echo '---'
              echo 'layout: page'
              echo "title: ${title}"
              echo 'permalink: /projects/'"$(basename "$f" .md)"'/'   # pretty URL
              echo '---'
              cat "$f"
            } > "$tmp"
            mv "$tmp" "$f"
          done

      - name: Build index.md
        run: |
          python - <<'PY'
          import os, urllib.parse
          files = sorted([f for f in os.listdir('projects') if f.endswith('.md')])
          with open('index.md', 'w', encoding='utf-8') as out:
              out.write('---\nlayout: home\ntitle: Selected Projects\n---\n\n')
              out.write("Welcome! These are curated projects across Audio, AI, and full-stack engineering.\n\n")
              for f in files:
                  title = os.path.splitext(f)[0].split('-', 1)[-1].replace('-', ' ')
                  url = 'projects/' + urllib.parse.quote(f)
                  out.write(f'- [{title}]({url})\n')
          PY

      - name: Ensure Jekyll config exists
        run: |
          if [ ! -f _config.yml ]; then
            cat > _config.yml <<'YML'
          title: Audio • AI • Engineering
          theme: minima
          description: Selected project summaries by <Your Name>
          markdown: kramdown
          YML
          fi

      - name: Commit and push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Sync approved summaries from private repo

          ⚠️  Visual formatting pending - needs manual application
          Reference template: projects/02-Density-DAW.md

          Use Claude Code to apply visual enhancements:
          - Highlight boxes with key achievements
          - Metrics showcasing impact
          - Two-column layouts for scannability"
            git push
          else
            echo "No changes to commit."
          fi
