name: Sync Approved Summaries

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"   # Every Monday 09:00 UTC (optional)

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Checkout private repo (read-only)
        uses: actions/checkout@v4
        with:
          repository: spearse/projectsummaries
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          path: private_src
          ref: main
          submodules: false
          fetch-depth: 1

      - name: Prepare folders
        run: |
          mkdir -p projects
          echo "Project files are manually maintained with full Jekyll front matter"

      - name: Set up Python for transformation
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Copy and transform project summaries from portfolio-web
        run: |
          # File mappings: source (in projectSummaries/portfolio-web) -> destination (in portfolio)
          declare -A mappings=(
            ["density-copilot.md"]="projects/01-Density-Copilot.md"
            ["density-daw.md"]="projects/02-Density-DAW.md"
            ["compose-with-sounds.md"]="projects/03-Compose-with-Sounds.md"
            ["clamp3-semantic-search.md"]="projects/04-CLaMP3-Audio-Semantic-Search.md"
            ["density-fullstack.md"]="projects/05-Density-Web-Platform.md"
            ["cv.md"]="cv.md"
          )

          for source in "${!mappings[@]}"; do
            dest="${mappings[$source]}"
            source_path="private_src/portfolio-web/$source"
            dest_path="$dest"

            if [ -f "$source_path" ]; then
              echo "Processing $source -> $dest"

              title=$(head -n 1 "$source_path" | sed 's/^# //')
              slug=$(basename "$dest" .md)
              if [[ "$dest" == projects/* ]]; then
                permalink="/${dest%.md}.html"
              else
                permalink="/${slug}/"
              fi

              mkdir -p "$(dirname "$dest_path")"
              printf -- '---\nlayout: default\ntitle: %s\npermalink: %s\n---\n\n' "$title" "$permalink" > "$dest_path"
              cat "$source_path" >> "$dest_path"
              echo "✅ Copied $dest"
            else
              echo "⚠️  Source file not found: $source_path"
            fi
          done

          echo ""
          echo "⚠️  NOTE: Visual formatting may need manual touch-up"
          echo "Reference template: projects/02-Density-DAW.md"

      - name: Ensure front-matter on project pages
        run: |
          for f in projects/*.md; do
            if [ "$(head -n1 "$f")" = "---" ]; then
              continue
            fi
            title="$(basename "$f" .md | sed 's/^[0-9]\+-//' | sed 's/-/ /g')"
            tmp="$(mktemp)"
            {
              echo '---'
              echo 'layout: page'
              echo "title: ${title}"
              echo 'permalink: /projects/'"$(basename "$f" .md)"'/'
              echo '---'
              cat "$f"
            } > "$tmp"
            mv "$tmp" "$f"
          done

      # Index is manually designed; do not overwrite

      - name: Ensure Jekyll config exists
        run: |
          if [ ! -f _config.yml ]; then
            cat > _config.yml <<'YML'
          title: Audio • AI • Engineering
          theme: minima
          description: Selected project summaries by <Your Name>
          markdown: kramdown
          YML
          fi

      - name: Commit and push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Sync approved summaries from private repo"
            git push
          else
            echo "No changes to commit."
          fi
