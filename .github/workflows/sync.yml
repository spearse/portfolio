name: Sync Approved Summaries

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"   # Every Monday 09:00 UTC (optional)

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Checkout private repo (read-only)
        uses: actions/checkout@v4
        with:
          repository: spearse/projectsummaries   # <-- your PRIVATE repo name
          token: ${{ secrets.PRIVATE_REPO_PAT }} # <-- fine-grained PAT secret on public repo
          path: private_src
          ref: main
          submodules: false
          fetch-depth: 1

      - name: Prepare folders
        run: |
          mkdir -p projects
          # DISABLED: rm -rf projects/*
          # Project files are now manually maintained with full Jekyll front matter
          echo "Project files are manually maintained"

      - name: Copy project summaries from portfolio-web
        run: |
          # WORKFLOW CURRENTLY DISABLED
          # Portfolio project pages are manually maintained with full Jekyll formatting
          #
          # To re-enable automated syncing:
          # 1. Ensure projectSummaries/portfolio-web files have proper Jekyll front matter
          # 2. Update the copy commands below to match current file structure
          # 3. Uncomment the rm -rf above
          #
          # Current manual files:
          #   - projects/01-Density-Copilot.md (VC-validated AI assistant)
          #   - projects/02-Density-DAW.md (C++/JUCE professional DAW)
          #   - projects/03-Compose-with-Sounds.md (EU-funded educational DAW)
          #   - projects/04-CLaMP3-Audio-Semantic-Search.md (ML semantic search)
          #   - projects/05-Density-Web-Platform.md (Full-stack RTO payment system)
          echo "Sync workflow is currently disabled - files are manually maintained"
          
      - name: Ensure front-matter on project pages
        run: |
          for f in projects/*.md; do
            # If file already has front matter, skip
            if [ "$(head -n1 "$f")" = "---" ]; then
              continue
            fi
            title="$(basename "$f" .md | sed 's/^[0-9]\+-//' | sed 's/-/ /g')"
            tmp="$(mktemp)"
            {
              echo '---'
              echo 'layout: page'
              echo "title: ${title}"
              echo 'permalink: /projects/'"$(basename "$f" .md)"'/'   # pretty URL
              echo '---'
              cat "$f"
            } > "$tmp"
            mv "$tmp" "$f"
          done

      - name: Build index.md
        run: |
          python - <<'PY'
          import os, urllib.parse
          files = sorted([f for f in os.listdir('projects') if f.endswith('.md')])
          with open('index.md', 'w', encoding='utf-8') as out:
              out.write('---\nlayout: home\ntitle: Selected Projects\n---\n\n')
              out.write("Welcome! These are curated projects across Audio, AI, and full-stack engineering.\n\n")
              for f in files:
                  title = os.path.splitext(f)[0].split('-', 1)[-1].replace('-', ' ')
                  url = 'projects/' + urllib.parse.quote(f)
                  out.write(f'- [{title}]({url})\n')
          PY

      - name: Ensure Jekyll config exists
        run: |
          if [ ! -f _config.yml ]; then
            cat > _config.yml <<'YML'
          title: Audio • AI • Engineering
          theme: minima
          description: Selected project summaries by <Your Name>
          markdown: kramdown
          YML
          fi

      - name: Commit and push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Sync approved summaries from private repo"
            git push
          else
            echo "No changes to commit."
          fi
